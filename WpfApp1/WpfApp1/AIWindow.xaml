<Window x:Class="WpfApp1.AIWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:WpfApp1"
        Title="AI Trợ Lý" Height="700" Width="1000"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource WindowBg}"
        AllowDrop="True"
        PreviewDragOver="Window_PreviewDragOver"
        Drop="Window_Drop">

    <!-- ========== THEME & RESOURCES ========== -->
    <Window.Resources>
        <!-- Nền tổng thể (dark) -->
        <SolidColorBrush x:Key="WindowBg" Color="#050816"/>
        <SolidColorBrush x:Key="CardBg"   Color="#0B1020"/>
        <SolidColorBrush x:Key="TitleFg"  Color="#F9FAFB"/>
        <SolidColorBrush x:Key="SubFg"    Color="#9CA3AF"/>

        <!-- Input -->
        <SolidColorBrush x:Key="InputBg"  Color="#020617"/>
        <SolidColorBrush x:Key="InputBrd" Color="#4F46E5"/>

        <!-- Header gradient kiểu Gemini -->
        <LinearGradientBrush x:Key="HeaderGrad" StartPoint="0,0" EndPoint="1,0">
            <GradientStop Color="#4F46E5" Offset="0"/>
            <GradientStop Color="#6366F1" Offset="0.4"/>
            <GradientStop Color="#0EA5E9" Offset="1"/>
        </LinearGradientBrush>

        <!-- Converters -->
        <local:BoolToAlignConverter      x:Key="BoolToAlign"/>
        <!-- AI dùng xanh sáng hơn để khỏi bị mờ -->
        <local:BoolToBrushConverter      x:Key="BoolToBrush"
                                         UserHex="#22C55E"
                                         AiHex="#2563EB"/>
        <local:BoolToTextBrushConverter  x:Key="BoolToTextBrush"
                                         UserHex="#ECFDF5"
                                         AiHex="#E5E7EB"/>
        <local:BoolToVisibilityConverter x:Key="BoolToVisibility"/>

        <!-- ===== Styles ===== -->

        <!-- Chat bubble + shadow -->
        <Style x:Key="ChatBubble" TargetType="Border">
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="4 6"/>
            <Setter Property="MaxWidth" Value="640"/>
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="12"
                                      ShadowDepth="0"
                                      Opacity="0.35"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Input textbox pill -->
        <Style x:Key="RoundedTextBox" TargetType="TextBox">
            <Setter Property="Background" Value="{DynamicResource InputBg}"/>
            <!-- dùng TitleFg để khi chuyển sáng text vẫn rõ -->
            <Setter Property="Foreground" Value="{DynamicResource TitleFg}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource InputBrd}"/>
            <Setter Property="BorderThickness" Value="1.2"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="bd"
                                CornerRadius="16"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ScrollViewer x:Name="PART_ContentHost"
                                          VerticalScrollBarVisibility="Auto"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="BorderBrush" Value="#818CF8"/>
                            </Trigger>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="bd" Property="BorderBrush" Value="#A5B4FC"/>
                                <Setter TargetName="bd" Property="BorderThickness" Value="1.8"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Icon button tròn -->
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="Foreground" Value="#E5E7EB"/>
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd" CornerRadius="999"
                                Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#1F2937"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#0F172A"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Nút primary dài (New chat, Send) -->
        <Style x:Key="PrimaryPillButton"
               TargetType="Button"
               BasedOn="{StaticResource IconButton}">
            <Setter Property="Width" Value="Auto"/>
            <Setter Property="Padding" Value="14,8"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="#22C55E"/>
            <Setter Property="Foreground" Value="#022C22"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="bd" CornerRadius="999"
                                Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              Margin="4,0"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#4ADE80"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#16A34A"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="bd" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Item lịch sử bên trái -->
        <Style TargetType="ListBoxItem" x:Key="HistItem">
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="card"
                                CornerRadius="12"
                                Background="#020617"
                                BorderBrush="#111827"
                                BorderThickness="1"
                                SnapsToDevicePixels="True">
                            <Grid Margin="10">
                                <ContentPresenter/>
                            </Grid>
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10"
                                                  ShadowDepth="0"
                                                  Opacity="0.25"/>
                            </Border.Effect>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="card" Property="Background" Value="#020617"/>
                                <Setter TargetName="card" Property="BorderBrush" Value="#4F46E5"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="card" Property="Background" Value="#111827"/>
                                <Setter TargetName="card" Property="BorderBrush" Value="#818CF8"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- ========== LAYOUT CHÍNH ========== -->
    <Grid Background="{DynamicResource WindowBg}">
        <Grid.ColumnDefinitions>
            <!-- Sidebar history, toggle bằng nút ☰ -->
            <ColumnDefinition x:Name="colSidebar" Width="0"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- ========== SIDEBAR LỊCH SỬ ========== -->
        <Border Grid.Column="0"
                Background="#020617"
                BorderBrush="#111827"
                BorderThickness="0,0,1,0">
            <Grid Margin="14">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header + search -->
                <StackPanel Grid.Row="0" Orientation="Vertical">
                    <TextBlock Text="Lịch sử trò chuyện"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TitleFg}"/>
                    <TextBlock Text="Bạn có thể xem lại các cuộc trò chuyện trước đó"
                               Margin="0,2,0,10"
                               FontSize="11"
                               Foreground="{DynamicResource SubFg}"/>

                    <Border Background="#020617"
                            BorderBrush="#111827"
                            BorderThickness="1"
                            CornerRadius="999"
                            Padding="8,4"
                            Margin="0,0,0,4">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Text="🔍"
                                       VerticalAlignment="Center"
                                       Margin="2,0,8,0"
                                       Foreground="#6B7280"/>
                            <TextBox x:Name="txtSearchHist"
                                     Grid.Column="1"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     Foreground="{DynamicResource TitleFg}"
                                     FontSize="12"
                                     Padding="0"
                                     ToolTip="Tìm trong lịch sử"
                                     TextChanged="txtSearchHist_TextChanged"/>
                        </Grid>
                    </Border>
                </StackPanel>

                <!-- Danh sách -->
                <ListBox Grid.Row="1"
                         x:Name="lstConversations"
                         Background="Transparent"
                         BorderThickness="0"
                         Foreground="{DynamicResource TitleFg}"
                         ItemContainerStyle="{StaticResource HistItem}"
                         SelectionChanged="lstConversations_SelectionChanged">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0"
                                           Text="{Binding Title, FallbackValue=Cuộc trò chuyện}"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TitleFg}"
                                           TextTrimming="CharacterEllipsis"/>
                                <StackPanel Grid.Row="1"
                                            Orientation="Horizontal"
                                            Margin="0,4,0,0">
                                    <TextBlock Text="{Binding Messages[0].Message}"
                                               Width="150"
                                               FontSize="11"
                                               Foreground="{DynamicResource SubFg}"
                                               TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text=" • "
                                               FontSize="11"
                                               Foreground="{DynamicResource SubFg}"/>
                                    <TextBlock Text="{Binding CreatedUtc, StringFormat={}{0:dd/MM/yyyy HH:mm}}"
                                               FontSize="11"
                                               Foreground="{DynamicResource SubFg}"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- ========== MAIN CHAT CARD ========== -->
        <Border Grid.Column="1"
                Background="{DynamicResource CardBg}"
                CornerRadius="26"
                Margin="18">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- header -->
                    <RowDefinition Height="*"/>
                    <!-- chat -->
                    <RowDefinition Height="Auto"/>
                    <!-- attachments -->
                    <RowDefinition Height="Auto"/>
                    <!-- input -->
                    <RowDefinition Height="Auto"/>
                    <!-- mic label -->
                </Grid.RowDefinitions>

                <!-- HEADER -->
                <Border Grid.Row="0"
                        CornerRadius="24,24,0,0"
                        Background="{DynamicResource HeaderGrad}"
                        Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Logo + title -->
                        <StackPanel Orientation="Horizontal"
                                    VerticalAlignment="Center">
                            <!-- Logo đơn giản: vòng tròn + emoji -->
                            <Border Width="36" Height="36"
                                    CornerRadius="18"
                                    Background="#1E293B"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                                <TextBlock Text="🤖"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontSize="20"/>
                            </Border>
                            <StackPanel Margin="10,0,0,0">
                                <TextBlock x:Name="lblTitle"
                                           Text="AI Trợ Lý"
                                           FontSize="20"
                                           FontWeight="Bold"
                                           Foreground="White"/>
                                <TextBlock x:Name="lblMode"
                                           Text="Online"
                                           FontSize="11"
                                           Foreground="#E0E7FF"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Center: model info -->
                        <StackPanel Grid.Column="1"
                                    HorizontalAlignment="Center"
                                    Orientation="Horizontal"
                                    VerticalAlignment="Center">
                            <Border Background="#0B1120"
                                    CornerRadius="999"
                                    Padding="10,4"
                                    Margin="8,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="✨ Gemini-style"
                                               FontSize="11"
                                               Foreground="#E5E7EB"/>
                                    <TextBlock Text=" • "
                                               FontSize="11"
                                               Foreground="#6B7280"/>
                                    <TextBlock Text="Creative mode"
                                               FontSize="11"
                                               Foreground="#A5B4FC"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Right controls -->
                        <StackPanel Grid.Column="2"
                                    Orientation="Horizontal"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center">
                            <Button x:Name="btnMenu"
                                    Content="☰"
                                    Style="{StaticResource IconButton}"
                                    Background="#00000033"
                                    ToolTip="Mở/đóng lịch sử"
                                    Click="btnMenu_Click"/>
                            <!-- chỉ icon, không có chữ để khỏi che nút xanh -->
                            <Button x:Name="btnTheme"
                                    Content="☀️"
                                    Margin="6,0,0,0"
                                    Style="{StaticResource IconButton}"
                                    Background="#00000033"
                                    ToolTip="Đổi theme"
                                    Click="btnTheme_Click"/>
                            <Button Content="+ Cuộc trò chuyện mới"
                                    Margin="10,0,0,0"
                                    Style="{StaticResource PrimaryPillButton}"
                                    Click="BtnNewChat_Click"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- CHAT AREA -->
                <ScrollViewer x:Name="svChat"
                              Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              Margin="0,10,0,0">
                    <ItemsControl x:Name="icChat" Margin="20,10,20,20">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal"
                                            Margin="0,2"
                                            HorizontalAlignment="{Binding IsUser, Converter={StaticResource BoolToAlign}}">
                                    <!-- avatar -->
                                    <Border Width="34" Height="34"
                                            Margin="0,0,6,0"
                                            CornerRadius="999"
                                            Background="{Binding IsUser, Converter={StaticResource BoolToBrush}}">
                                        <TextBlock Text="👤"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   FontSize="16"/>
                                    </Border>

                                    <!-- bubble -->
                                    <Border Style="{StaticResource ChatBubble}"
                                            Background="{Binding IsUser, Converter={StaticResource BoolToBrush}}">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Message}"
                                                       TextWrapping="Wrap"
                                                       Foreground="{Binding IsUser, Converter={StaticResource BoolToTextBrush}}"/>

                                            <!-- file attachments -->
                                            <ItemsControl ItemsSource="{Binding Attachments}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Margin="6,8,0,0"
                                                                Padding="6"
                                                                CornerRadius="10"
                                                                Background="#020617"
                                                                BorderBrush="#1F2937"
                                                                BorderThickness="1">
                                                            <StackPanel Orientation="Horizontal">
                                                                <Image Source="{Binding Thumbnail}"
                                                                       Width="42" Height="42"
                                                                       Margin="0,0,8,0"
                                                                       Stretch="UniformToFill"
                                                                       Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibility}}"/>
                                                                <TextBlock Text="{Binding DisplayName}"
                                                                           VerticalAlignment="Center"
                                                                           Foreground="#E5E7EB"
                                                                           Width="160"
                                                                           TextWrapping="Wrap"
                                                                           FontSize="12"/>
                                                                <Button Content="Mở"
                                                                        Style="{StaticResource PrimaryPillButton}"
                                                                        Margin="8,0,0,0"
                                                                        Padding="12,4"
                                                                        Click="OpenAttachment_Click"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- PENDING ATTACHMENTS BAR -->
                <Border Grid.Row="2"
                        Margin="18,0,18,4"
                        Background="#020617"
                        BorderBrush="#111827"
                        BorderThickness="1"
                        CornerRadius="16"
                        Padding="6"
                        Visibility="{Binding ElementName=icPending, Path=HasItems, Converter={StaticResource BoolToVisibility}}">
                    <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Disabled">
                        <ItemsControl x:Name="icPending">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="4"
                                            Padding="6"
                                            Background="#020617"
                                            BorderBrush="#1F2937"
                                            BorderThickness="1"
                                            CornerRadius="12">
                                        <StackPanel Orientation="Horizontal">
                                            <Image Source="{Binding Thumbnail}"
                                                   Width="34" Height="34"
                                                   Margin="0,0,6,0"
                                                   Stretch="UniformToFill"
                                                   Visibility="{Binding IsImage, Converter={StaticResource BoolToVisibility}}"/>
                                            <TextBlock Text="{Binding DisplayName}"
                                                       VerticalAlignment="Center"
                                                       Foreground="#E5E7EB"
                                                       Width="160"
                                                       TextWrapping="Wrap"
                                                       FontSize="12"/>
                                            <Button Content="✕"
                                                    Style="{StaticResource IconButton}"
                                                    Width="30" Height="30"
                                                    Background="#DC2626"
                                                    Margin="6,0,0,0"
                                                    Click="RemovePending_Click"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

                <!-- INPUT AREA -->
                <Border Grid.Row="3"
                        Margin="18,6,18,12"
                        Background="#020617"
                        CornerRadius="20"
                        Padding="10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- textbox -->
                        <TextBox x:Name="txtQuestion"
                                 Grid.Column="0"
                                 Style="{StaticResource RoundedTextBox}"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 VerticalContentAlignment="Top"
                                 MinHeight="52"
                                 MaxHeight="120"
                                 KeyDown="TxtQuestion_KeyDown"
                                 ToolTip="Ctrl+Enter để gửi • Có thể kéo thả tệp, dán ảnh từ clipboard"/>

                        <!-- buttons -->
                        <StackPanel Grid.Column="1"
                                    Orientation="Horizontal"
                                    VerticalAlignment="Bottom"
                                    Margin="10,0,0,0">
                            <Button x:Name="btnMic"
                                    Content="🎤"
                                    Style="{StaticResource IconButton}"
                                    Background="#0EA5E9"
                                    ToolTip="Bật/Tắt micro"
                                    Click="BtnMic_Click"/>
                            <Button x:Name="btnAttach"
                                    Content="📎"
                                    Margin="6,0,0,0"
                                    Style="{StaticResource IconButton}"
                                    Background="#6366F1"
                                    ToolTip="Đính kèm tệp"
                                    Click="BtnAttach_Click"/>
                            <Button x:Name="btnSend"
                                    Content="Gửi ➤"
                                    Margin="10,0,0,0"
                                    Style="{StaticResource PrimaryPillButton}"
                                    Click="BtnSend_Click"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- MIC LABEL -->
                <TextBlock x:Name="lblMic"
                           Grid.Row="4"
                           Margin="24,0,0,14"
                           Foreground="#6B7280"
                           FontSize="11"
                           Text="Mic: Tắt"/>
            </Grid>
        </Border>
    </Grid>
</Window>
